---
title: "Lena-Pred Pitch Extraction Pipeline"
output: html_document
---

```{r, include = F}
knitr::opts_chunk$set(echo = T, warning = F, message = F,
                      fig.asp = 0.8, fig.width = 8,
                      fig.align = 'center', out.width = "80%")
```

## Setup and overview

```{r libraries}
library(soundgen); library(fst); library(tidyverse); library(here)
source(here("code/00_helper_functions/pitch_helpers.R"))
source(here("code/00_config/plot_theme.R"))
source(here("code/00_config/lena-pred-pitch-config.R"))
```

Load extracted pitch contours

```{r extracted pitch estimates}
d <- read_fst(here("data/03_summaries/lena-pred-pitch-vals.fst"))
d_clusters <- read_fst(here("data/03_summaries/lena-pred-poly-coefs.fst"))
d_centers <- read_fst(here("data/03_summaries/lena-pred-kmeans-centers.fst"))
d_by_bin <- read_rds(here("data/03_summaries/lena-pred-nested-pitch-vals.rds"))
```

```{r plot sample pitch contours}
segs_to_plot <- d %>% 
  distinct(dataset, seg_id, speech_register) %>% 
  group_by(dataset, speech_register) %>% 
  sample_n(2)

d %>% 
  filter(seg_id %in% segs_to_plot$seg_id) %>% 
  ggplot(aes(x = time, y = pitch_original, color = speech_register)) +
  geom_point(size = 2) +
  labs(x = "Time (ms)", y = "Pitch ") +
  lims(y = c(pitch_detect_config$pitch_min, pitch_detect_config$pitch_max)) +
  facet_wrap(dataset + speech_register~seg_id, ncol = 4) +
  theme(legend.position = 'top') +
  scale_color_ptol() 
```

Looks like we can extract pitch estimates from audio files in both datasets. 

## Interpolated pitch contour 

Let's plot the originial pitch estimates (points) with our interpolated pitch contours (black lines) to sanity check the interpolation step. 

```{r}
d %>% 
  filter(seg_id %in% segs_to_plot$seg_id) %>% 
  ggplot(aes(x = time, y = pitch_interpolated)) +
  geom_line(size = 2, color = "grey20") +
  geom_point(data = filter(d, seg_id %in% segs_to_plot$seg_id), 
             aes(time, pitch_original, color = speech_register), 
             size = 2, 
             alpha = 0.7) +
  labs(x = "Time (ms)", y = "Pitch") +
  lims(y = c(pitch_detect_config$pitch_min, pitch_detect_config$pitch_max)) +
  facet_wrap(dataset + speech_register~seg_id, ncol = 4) +
  theme(legend.position = 'top') +
  ggthemes::scale_color_ptol() 
```

These curves look reasonable to me, but the `span` parameter, which controls the wiggliness of the loess, is a free parameter that we should experiment with.

## Temporal segmentation 

Make a plot to sanity check temporal segmentation step where we color each point based on its 100 ms time bin.

```{r plot time bins}
one_seg_to_plot <- sample(segs_to_plot$seg_id, size = 1)

d %>% 
  filter(seg_id %in% one_seg_to_plot) %>% 
  ggplot(aes(x = time, y = z_log_pitch, color = time_bin)) +
  geom_point(size = 1) +
  guides(color = F) +
  labs(x = "Time (ms)", y = "Normalized log(Pitch)")  +
  facet_wrap(~seg_id) 
```

From the plot, it looks like the temporal segmentation step is working. 

## K-means clustering on poly coefs

We can plot the distribution of cluster assignments for each dataset. 

```{r plot clusters scatter}
plot_clusters_scatter(d_clusters)
```

```{r plot pitch shapes, include = F}
plot_sample_pitch_shapes(d_clusters, frac_sample = 0.1)
```

```{r plot distribution of cluster shapes}
d_clusters %>% 
  ggplot(aes(as_factor(cluster))) +
  geom_histogram(stat='count') +
  labs(x = "Cluster Category")
```

The top panel shows the polynomial shape for the center of each cluster generated by the kmeans clustering. The bottom panel shows a reconstructed pitch contour by plotting the 2nd order polynomial for each 100 ms time bin (bottom row) alongside the interpolated pitch contour (top row). The number displayed in each time bin facet represents the cluster assignment for that pitch shape based on the kmeans step. 

```{r plot pitch contour categories,}
plot_cluster_shapes(d_centers, scaled = TRUE)
```

```{r plot reconstructed pitch contour}
plot_reconstructed_pitch(one_seg_to_plot, 
                         df_raw = d_interp, 
                         df_preds = d_by_bin) 
```
