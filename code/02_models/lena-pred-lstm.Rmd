---
title: "LSTM implementation"
output: html_document
---

## Set up LSTM language model

Neural language models are designed to learn how to predict the next word in a sequence given the prior context. In our case, words are cluster assignments for each 100-ms segment of pitch contours.

This implementation of the LSTM below is borrowed from this [tutorial] (https://keras.rstudio.com/articles/examples/lstm_text_generation.html) where they implement a character-level neural language model. 

```{r libraries}
source(here::here("code/00_config/lena-pred-libraries.R"))
source(here("code/00_config/plot_theme.R"))
source(here("code/00_config/lena-pred-dnn-config.R"))
source(here("code/00_helper_functions/lstm-helpers.R"))
```

## Read model config and vectorize data

```{r vectorize data for passing to LSTM}
train_in <- vectorize_data(lstm_config$d$train_data, data_type = "input")
train_out <- vectorize_data(lstm_config$d$train_data, data_type = "output")
test_in <- vectorize_data(lstm_config$d$test_data, data_type = "input")
test_out <- vectorize_data(lstm_config$d$test_data, data_type = "output")
```

## Define model

```{r}
model <- keras_model_sequential()

model %>%
  layer_embedding(
    input_dim = lstm_config$input_shape, 
    output_dim = lstm_config$lstm_output_dim, 
    input_length = lstm_config$input_length) %>% 
  layer_lstm(units = lstm_config$lstm_units, 
             input_shape = c(lstm_config$input_length, 
                             lstm_config$input_shape)) %>%
  layer_dense(lstm_config$n_clusters, activation = "softmax")

model %>% compile(
  loss = "categorical_crossentropy", 
  optimizer = 'rmsprop',
  metrics = list('accuracy')
)

summary(model)
```

## Train the model

```{r}
m_fit <- model %>% 
  fit(train_in, 
      train_out,
      batch_size = lstm_config$batch_size,
      epochs = lstm_config$n_epochs,
      validation_split = lstm_config$validation_split,
      shuffle = lstm_config$shuffle,
      callbacks = lstm_config$early_stop
  ) 
```

Visualize the change in loss function during training.

```{r}
plot(m_fit)
```

## Evaluate the model

```{r}
results <- model %>% keras::evaluate(test_in, test_out)
results
```

## Generate predictions 

Get a predicted probability distribution over each cluster in test sequences and save these predictions for later analysis, adding all relevant metadata. 

```{r}
preds <- model %>% predict(test_in)
```

## Tidy up the model predictions for later analysis.

```{r}
d_preds <- preds %>% 
  as_tibble(.name_repair = "universal") %>% 
  clean_names()

colnames(d_preds) <- colnames(d_preds) %>% str_replace("x", "shape_")

d_preds %>% 
  mutate(seg_id = lstm_config$d$test_data$next_cluster_seg_id %>% as.character(),
         speech_register = lstm_config$d$test_data$next_cluster_speech_register %>% as.character(),
         time_bin_id = lstm_config$d$test_data$next_cluster_time_bin_id %>% as.character(),
         target_cluster = lstm_config$d$test_data$next_cluster %>% as.character(),
         dataset = lstm_config$d$test_data$next_cluster_dataset %>% as.character(),
         duration_nbins = lstm_config$d$test_data$next_cluster_duration_nbins %>% as.character()) %>% 
  select(seg_id, dataset, speech_register, time_bin_id, target_cluster, duration_nbins,
         everything()) -> d_preds

# tidy the predictions
first_shape_col <- "shape_1"
last_shape_col <- colnames(d_preds)[colnames(d_preds) %>% length()]

d_preds_tidy <- d_preds %>% 
  gather(key = "cluster_shape", 
         value = "prob_mass", 
         first_shape_col:last_shape_col)
```

Get the posterior probability mass placed on the correct cluster, get the predicted cluster, and change dataset label to lowercase.

```{r}
d_preds_tidy %>% 
  group_by(seg_id, time_bin_id) %>% 
  mutate(is_target_cluster = ifelse(str_detect(cluster_shape, target_cluster), TRUE, FALSE),
         predicted_cluster = which.max(prob_mass),
         dataset = str_to_lower(dataset),
         correct_pred = ifelse(target_cluster == predicted_cluster, 1, 0)) -> d_preds_tidy
```

Save predictions

```{r}
if (lstm_config$use_rasanen) {
  write_fst(d_preds_tidy, here(read_path, "lena-pred-lstm-preds-rasanen.fst"))  
} else {
  write_fst(d_preds_tidy, here(read_path, "lena-pred-lstm-preds.fst"))  
}
```
