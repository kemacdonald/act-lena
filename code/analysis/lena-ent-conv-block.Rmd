---
title: "Act-lena Conversations"
author: "Kyle MacDonald"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Setup

```{r libraries}
source(here::here('code/helper_functions/entropy_helpers.R'))
source(here::here('code/helper_functions/helpers.R'))
library(fst)
library(lubridate)
library(magrittr)
library(tidyverse)
```

The full data takes some time to load into memory, so we use the `to` and `from` arguments to load a subset of the data.

```{r read data}
 d <- read_fst(path = here::here("data/02_processed_data/act-lena-blocks.fst"))
```

## Some data cleaning and variable creation

```{r}
d_long <- d %>% 
  select(child_id, blk_id, blk_type, start_clock_time_local, 
         child_age_months, tvf:faf, adult_word_cnt) %>% 
  gather(key = sound_type, value = time_sec, tvf:faf)
```

Now we can compute time summary measures for each audio sound for each conversation. 

```{r}
d_long %<>% 
  group_by(child_id, blk_id, child_age_months) %>% 
  mutate(blk_len_sec = sum(time_sec),
         adult_word_cnt = ifelse(is.na(adult_word_cnt), 0, adult_word_cnt),
         max_sound_code = get_longest_sound_type(sound_type, time_sec))
```

Convert time so all are on the same day (only care about days here, not time of year).

```{r}
d_long %<>% mutate(start_clock_clean = convert_date(start_clock_time_local))
```

Clean up the sound activity names

```{r}
make_better_code_names <- function(old_code) {
  case_when(
    str_detect(old_code, "fa+") ~ "female_adult",
    old_code == "sil" ~ "silence",
    str_detect(old_code, "no+") ~ "noise",
    str_detect(old_code, "ol+") ~ "overlap",
    str_detect(old_code, "tv+") ~ "electronic",
    str_detect(old_code, "ma+") ~ "male_adult",
    str_detect(old_code, "ch+") ~ "key_child",
    str_detect(old_code, "cx+") ~ "other_child",
  )
}

d_long %<>% 
  mutate(conv_sound_type = make_better_code_names(max_sound_code),
         seg_sound_type = make_better_code_names(sound_type))
```


### Time course plots

Plot the spikes in adult word count throughout the day.

```{r}
d_long %>% 
  ggplot(aes(start_clock_clean, adult_word_cnt)) +
  geom_line() +
  facet_grid(child_id~child_age_months) 
```

Plot the changes in sound types over the course of the day.

```{r}
d_conv <- d_long %>% 
  distinct(child_id, blk_type, child_age_months, conv_sound_type,
           blk_id, start_clock_clean, adult_word_cnt)
```  

Now plot.time course of SAD.as a function of time of the day.
  
```{r}
d_conv %>% 
  filter(child_id == "0009", child_age_months == 3) %>% 
  filter(blk_type == "conversation") %>% 
  ggplot(aes(start_clock_clean, conv_sound_type)) +
  geom_point(alpha = 0.3, size = 3) +
  facet_grid(child_id~child_age_months) +
  labs(x = "Time of Day", y = "Auditory Event")
```

Summarise adult word counts across ages and participants

```{r}
d_conv %>% 
  filter(blk_type == "conversation") %>% 
  group_by(child_id, child_age_months) %>% 
  summarise(m = mean(adult_word_cnt)) 
```

Next, let's just look at one conversation.

```{r}
d_segs <- d_long %>% 
  filter(adult_word_cnt >= 40, adult_word_cnt <= 50,
         child_age_months == 3, child_id == "0009")
```

Plot histogram of time in each event in this conversation.

```{r}
blk_ids_plot <- d_segs %>% pull(blk_id) %>% unique() %>% sample(2)

d_segs %>% 
  filter(blk_id %in% blk_ids_plot) %>% 
  mutate(awc_facet_label = paste("AWC =", adult_word_cnt)) %>% 
  ggplot(aes(x = seg_sound_type, y = time_sec)) + 
  geom_bar(stat = 'identity', width = 0.6) +
  facet_wrap(~awc_facet_label) +
  labs(x = "Segment Sound Activity", y = "Time (sec)") +
  ggtitle(label = 'Sound Activity Distributions') 
```

Plot timecourse of sound events in a single conversation.

```{r}
d_test <- d_segs %>% filter(blk_id %in% blk_ids_plot) 

# expand the conversation
test_expanded <- expand_conv(d_test, samp_rate = 1) 

d_test %>%  
  ggplot(aes(time_sec, conv_sound_type)) +
  geom_point(alpha = 0.3, size = 3) +
  facet_grid(blk_id~child_age_months) +
  labs(x = "Time of Day", y = "Auditory Event")
```

### Entropy computations

Get entropy of different sounds types over the course of the day

```{r}
d_conv %>% 
  filter(conversation_sound_type != "key_child") %>% 
  mutate(conv_snd_numeric = case_when(
    conversation_sound_type == "silence" ~ 0,
    conversation_sound_type == "overlap" ~ 1,
    conversation_sound_type == "noise" ~ 2,
    conversation_sound_type == "female_adult" ~ 3,
    conversation_sound_type == "male_adult" ~ 4,
    conversation_sound_type == "other_child" ~ 5,
    conversation_sound_type == "electronic" ~ 6,
  )) %>% 
  group_by(child_id, child_age_months) %>% 
  summarise(ent_day = pracma::sample_entropy(conv_snd_numeric))
```

Compute entropy of word count vectors. TODO: I need to expand the vectors using the timing information 
