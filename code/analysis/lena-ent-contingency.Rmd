---
title: "Act-lena contingency windows"
author: "Kyle MacDonald"
output: html_document
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Setup

```{r libraries}
source(here::here('code/helper_functions/entropy_helpers.R'))
source(here::here('code/helper_functions/helpers.R'))
library(fst)
library(magrittr)
library(tidyverse)
```

The full data takes some time to load into memory, so we use the `to` and `from` arguments to load a subset of the data.

```{r read data}
start_file <- 1
end_file <- 287880 # this gives you the first child's data

 d <- read_fst(path = here::here("data/02_processed_data/act-lena-segments.fst"),
               from = start_file,
               to = end_file)
```

## Conversation length

Filter data to just include conversations.

```{r}
d_conv <- d %>% 
  filter(blk_type == "conversation", child_age_in_months == 3) %>% 
  select(child_id, blk_id, seg_id, speaker, start_time, segment_type,
         end_time, child_age_in_months, child_gender,
         blk_type, child_utt_cnt, start_clock_time_local, end_clock_time_local)
```

Add variable to track whether the child was present in the conversation.

```{r}
d_conv %<>% 
  group_by(blk_id) %>% 
  mutate(key_child_present = is_spkr_present(speaker, "key_child"),
         conversation_length = get_conv_length(start_time, end_time))
```

Plot conversation length as a function of whether child is present

```{r}
d_conv %>% 
  distinct(blk_id, conversation_length, key_child_present) %>% 
  filter(conversation_length > 1) %>% 
  ggplot(aes(x = key_child_present, y = conversation_length)) +
  ggbeeswarm::geom_quasirandom() + 
  coord_flip()
```

## Contingency of parent response after child vocalization

Create test case.to test my own expand sound activity functions. Goal is to get the timecourse of 
activity events within a conversation.

```{r}
# TODO: add functionality to handle different blocks that have very different
# start and end times

test <- d_conv %>% 
  filter(blk_id == 2) %>% 
  select(speaker, start_time, end_time, segment_type, blk_id, child_id)

test_expanded <- expand_conv(test, samp_rate = 0.25) 
```

Make plots.

```{r}
test_expanded %>% 
  ggplot(aes(x = time_sec, y = segment_type)) +
  geom_point(size = 5, alpha = 0.6) +
  labs(x = "Time (sec)", y = "Segment Type") +
  facet_wrap(~blk_id, ncol = 1)
```

### Compute contingency of adult response after child 

```{r}

```

### Categorical auto-recurrence model

```{r parameters}
delay <- 1; embed <- 1; rescale <- 1; radius <- 0.0001;
normalize <- 0; mindiagline <- 2; minvertline <- 2;
tw <- 1 # Theiler window set to 1 to remove the Line of Incidence
```

```{r}
res <- crqa::crqa(test_expanded$spkr_numeric, test_expanded$spkr_numeric, 
            delay, embed, rescale, radius, normalize,
            mindiagline, minvertline, tw, 
            checkl = list(do = TRUE, datatype = "categorical", thrshd = 10))
```

Make plot

```{r}
RP <- res$RP # take out the recurrence plot
RP_mat <- matrix(as.numeric(RP), nrow = length(test_expanded$spkr)) 
plot_pars <- list(unit = 2, labelx = "Time", labely = "Time", cols = "blue", pcex = 1)
crqa::plotRP(RP, plot_pars)
```

Now try for another conversation

```{r}
test_conv2 <- d_conv %>% 
  filter(blk_id == 128) %>% 
  select(spkr, start_time, end_time) %>% 
  expand_conv(samp_rate = 1) %>% 
  mutate(
    spkr_numeric = case_when(
    spkr %in% c("MAN", "MAF") ~ 0,
    spkr %in% c("FAN", "FAF") ~ 1,
    spkr %in% c("CHN", "CHX") ~ 2,
    spkr %in% c("CXN", "CXF") ~ 3,
    spkr %in% c("NON", "NOF") ~ 4,
    spkr %in% c("TVN", "TVF") ~ 5,
    spkr %in% c("OLN", "OLF") ~ 6,
    spkr %in% c("SIL") ~ 7),
    spkr_fact = spkr_numeric %>% as.character %>% as_factor()
  ) 

b <- test_conv2 %>% 
  ggplot(aes(x = time_sec, y = spkr, color = spkr)) +
  geom_point()
```

```{r}
cowplot::plot_grid(a, b)
```


Fit model

```{r}
res2 <- crqa::crqa(test_conv2$spkr_numeric, test_conv2$spkr_numeric, 
            delay, embed, rescale, radius, normalize,
            mindiagline, minvertline, tw, 
            checkl = list(do = TRUE, datatype = "categorical", thrshd = 10))
```

Make plot

```{r}
RP2 <- res2$RP # take out the recurrence plot
RP_mat2 <- matrix(as.numeric(RP2), nrow = length(test_conv2$spkr)) 
crqa::plotRP(RP_mat2, plot_pars)
```


```{r}
cbind( unlist(res[1:9]), unlist(res2[1:9]) )
```


